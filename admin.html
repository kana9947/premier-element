<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <title>Admin â€” Gestion des tarifs | Premier Element</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="images/logo-icon.svg">
  <link rel="stylesheet" href="css/style.css">
  <style>
    .admin-hero {
      padding: 140px 0 40px;
      background: linear-gradient(135deg, var(--primary-dark), var(--primary));
      color: #fff;
      text-align: center;
    }
    .admin-hero h1 { color: #fff; }

    /* Login */
    .login-card {
      max-width: 400px;
      margin: 0 auto;
      background: #fff;
      border-radius: var(--border-radius);
      padding: 40px;
      border: 1px solid var(--gray-200);
      box-shadow: var(--shadow-md);
      text-align: center;
    }
    .login-card h2 { margin-bottom: 24px; }
    #loginError {
      color: var(--error);
      font-size: 0.9rem;
      margin-top: 12px;
      display: none;
    }

    /* Admin panel */
    .admin-panel { display: none; }
    .admin-panel.visible { display: block; }

    /* Tabs navigation */
    .admin-tabs {
      display: flex;
      gap: 0;
      margin-bottom: 32px;
      border-bottom: 2px solid var(--gray-200);
    }
    .admin-tab {
      padding: 14px 28px;
      font-weight: 600;
      font-size: 1rem;
      color: var(--gray-500);
      cursor: pointer;
      border: none;
      background: none;
      font-family: var(--font-body);
      position: relative;
      transition: var(--transition);
    }
    .admin-tab:hover { color: var(--gray-700); }
    .admin-tab.active {
      color: var(--primary);
    }
    .admin-tab.active::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary);
      border-radius: 3px 3px 0 0;
    }
    .admin-tab-panel { display: none; }
    .admin-tab-panel.active { display: block; }

    .tarif-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .tarif-card {
      background: #fff;
      border-radius: var(--border-radius);
      padding: 32px;
      border: 1px solid var(--gray-200);
      box-shadow: var(--shadow-sm);
    }
    .tarif-card h3 {
      margin-bottom: 24px;
      padding-bottom: 12px;
      border-bottom: 2px solid var(--gray-100);
    }

    .tarif-field {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
      gap: 16px;
    }
    .tarif-field label {
      font-weight: 500;
      color: var(--gray-600);
      font-size: 0.95rem;
      flex: 1;
    }
    .tarif-field .input-group {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .tarif-field input {
      width: 100px;
      padding: 10px 12px;
      border: 2px solid var(--gray-200);
      border-radius: var(--border-radius-sm);
      font-size: 1rem;
      text-align: right;
      font-family: var(--font-body);
      color: var(--gray-700);
      transition: var(--transition);
    }
    .tarif-field input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(27,58,92,0.1);
    }
    .tarif-field .unit {
      color: var(--gray-400);
      font-size: 0.9rem;
      min-width: 30px;
    }

    /* Reservations */
    .resa-filters {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    .resa-filter-btn {
      padding: 8px 20px;
      border: 2px solid var(--gray-200);
      border-radius: 50px;
      background: #fff;
      cursor: pointer;
      font-family: var(--font-body);
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--gray-600);
      transition: var(--transition);
    }
    .resa-filter-btn:hover { border-color: var(--gray-300); }
    .resa-filter-btn.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }
    .resa-filter-btn .badge {
      display: inline-block;
      background: rgba(255,255,255,0.2);
      padding: 1px 8px;
      border-radius: 50px;
      font-size: 0.8rem;
      margin-left: 6px;
    }
    .resa-filter-btn.active .badge { background: rgba(255,255,255,0.3); }

    .resa-list { display: flex; flex-direction: column; gap: 16px; }
    .resa-card {
      background: #fff;
      border-radius: var(--border-radius);
      padding: 24px;
      border: 1px solid var(--gray-200);
      box-shadow: var(--shadow-sm);
    }
    .resa-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    .resa-id {
      font-weight: 700;
      font-size: 0.9rem;
      color: var(--gray-500);
    }
    .resa-statut {
      padding: 4px 14px;
      border-radius: 50px;
      font-weight: 600;
      font-size: 0.8rem;
    }
    .resa-statut.en_attente { background: #fff3cd; color: #856404; }
    .resa-statut.approuve { background: #d4edda; color: #155724; }
    .resa-statut.refuse { background: #f8d7da; color: #721c24; }

    .resa-details {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px;
    }
    .resa-detail-item {
      font-size: 0.9rem;
    }
    .resa-detail-item .resa-label {
      display: block;
      color: var(--gray-400);
      font-size: 0.8rem;
      margin-bottom: 2px;
    }
    .resa-detail-item .resa-value {
      font-weight: 600;
      color: var(--gray-700);
    }

    .resa-actions {
      display: flex;
      gap: 12px;
      padding-top: 16px;
      border-top: 1px solid var(--gray-100);
    }
    .resa-btn {
      padding: 8px 24px;
      border-radius: var(--border-radius-sm);
      border: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      font-family: var(--font-body);
      transition: var(--transition);
    }
    .resa-btn-approve { background: var(--success); color: #fff; }
    .resa-btn-approve:hover { opacity: 0.9; }
    .resa-btn-refuse { background: var(--error); color: #fff; }
    .resa-btn-refuse:hover { opacity: 0.9; }

    .resa-empty {
      text-align: center;
      padding: 48px;
      color: var(--gray-400);
      font-size: 1rem;
    }

    .save-bar {
      position: sticky;
      bottom: 0;
      background: #fff;
      border-top: 1px solid var(--gray-200);
      padding: 16px 0;
      margin-top: 40px;
      box-shadow: 0 -4px 16px rgba(0,0,0,0.08);
    }
    .save-bar .container {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .save-status {
      font-size: 0.9rem;
      color: var(--gray-500);
    }
    .save-status.saved { color: var(--success); font-weight: 600; }
    .save-buttons {
      display: flex;
      gap: 12px;
    }

    .last-update {
      text-align: center;
      color: var(--gray-400);
      font-size: 0.85rem;
      margin-top: 24px;
    }

    @media (max-width: 768px) {
      .tarif-grid { grid-template-columns: 1fr; }
      .tarif-field { flex-direction: column; align-items: flex-start; gap: 8px; }
      .tarif-field input { width: 100%; }
      .save-bar .container { flex-direction: column; gap: 12px; }
      .resa-details { grid-template-columns: 1fr 1fr; }
      .admin-tabs { overflow-x: auto; }
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="header" id="header">
    <div class="container">
      <a href="index.html" class="logo">
        <div class="logo-icon">PE</div>
        Premier <span>Element</span>
      </a>
      <nav class="nav-links" id="navLinks">
        <a href="index.html">Accueil</a>
        <a href="services.html">Services</a>
        <a href="about.html">A propos</a>
        <a href="contact.html">Contact</a>
        <a href="contact.html" class="btn btn-primary nav-cta">Soumission gratuite</a>
      </nav>
      <button class="burger" id="burger" aria-label="Menu">
        <span></span><span></span><span></span>
      </button>
    </div>
  </header>

  <!-- HERO -->
  <section class="admin-hero">
    <div class="container">
      <h1>Panneau <span style="color: var(--accent);">Administration</span></h1>
      <p style="opacity: 0.8;">Gerez vos tarifs et reservations de demenagement.</p>
    </div>
  </section>

  <!-- LOGIN -->
  <section class="section" id="loginSection">
    <div class="container">
      <div class="login-card">
        <h2>Connexion admin</h2>
        <form id="loginForm">
          <div class="form-group">
            <label for="adminPass">Mot de passe</label>
            <input type="password" id="adminPass" placeholder="Entrez le mot de passe admin" required>
          </div>
          <button type="submit" class="btn btn-primary" style="width: 100%;">Se connecter</button>
          <div id="loginError">Mot de passe incorrect.</div>
        </form>
      </div>
    </div>
  </section>

  <!-- ADMIN PANEL -->
  <section class="section admin-panel" id="adminPanel">
    <div class="container">

      <!-- Onglets -->
      <div class="admin-tabs">
        <button class="admin-tab active" data-tab="tarifs">Tarifs</button>
        <button class="admin-tab" data-tab="reservations">Reservations <span class="badge" id="resaCount">0</span></button>
      </div>

      <!-- TAB : TARIFS -->
      <div class="admin-tab-panel active" id="tabTarifs">
        <div class="tarif-grid">

          <!-- Taux horaires -->
          <div class="tarif-card">
            <h3>Taux horaires (3 demenageurs + camion)</h3>

            <div class="tarif-field">
              <label>Taux de base</label>
              <div class="input-group">
                <input type="number" id="tauxHoraireBase" min="0" step="5">
                <span class="unit">$/h</span>
              </div>
            </div>

            <div class="tarif-field">
              <label>Majoration fin de semaine (sam/dim)</label>
              <div class="input-group">
                <input type="number" id="majorationWeekend" min="0" step="5">
                <span class="unit">$/h</span>
              </div>
            </div>

            <div class="tarif-field">
              <label>Majoration 1er juillet (25 juin - 7 juil.)</label>
              <div class="input-group">
                <input type="number" id="majorationJuillet" min="0" step="5">
                <span class="unit">$/h</span>
              </div>
            </div>

            <div class="tarif-field">
              <label>Majoration fin de mois (3 derniers jours)</label>
              <div class="input-group">
                <input type="number" id="majorationFinMois" min="0" step="5">
                <span class="unit">$/h</span>
              </div>
            </div>
          </div>

          <!-- Deplacement -->
          <div class="tarif-card">
            <h3>Deplacement</h3>

            <div class="tarif-field">
              <label>Heure fixe de deplacement (toujours facturee)</label>
              <div class="input-group">
                <input type="number" id="heureFixeDeplacement" min="0.5" step="0.5">
                <span class="unit">h</span>
              </div>
            </div>

            <div class="tarif-field">
              <label>Seuil hors ville (au-dela = temps reel)</label>
              <div class="input-group">
                <input type="number" id="seuilDeplacementMin" min="10" step="5">
                <span class="unit">min</span>
              </div>
            </div>

            <div class="tarif-field">
              <label>Vitesse moyenne en ville</label>
              <div class="input-group">
                <input type="number" id="vitesseMoyenne" min="10" step="5">
                <span class="unit">km/h</span>
              </div>
            </div>

            <div class="tarif-field">
              <label>Facteur trafic (multiplicateur temps route)</label>
              <div class="input-group">
                <input type="number" id="facteurTrafic" min="1" step="0.05">
                <span class="unit">x</span>
              </div>
            </div>
          </div>

          <!-- Pauses & Capacite -->
          <div class="tarif-card">
            <h3>Pauses & Capacite</h3>

            <div class="tarif-field">
              <label>Pause par heure de manutention</label>
              <div class="input-group">
                <input type="number" id="pauseParHeure" min="0" step="5">
                <span class="unit">min</span>
              </div>
            </div>

            <div class="tarif-field">
              <label>Nombre de demenageurs par equipe</label>
              <div class="input-group">
                <input type="number" id="nombreDemenageurs" min="1" step="1">
                <span class="unit"></span>
              </div>
            </div>

            <div class="tarif-field">
              <label>Nombre de camions (departs simultanes max)</label>
              <div class="input-group">
                <input type="number" id="nombreCamions" min="1" step="1">
                <span class="unit"></span>
              </div>
            </div>
          </div>

          <!-- Facteurs d'etage -->
          <div class="tarif-card">
            <h3>Facteurs d'etage (multiplicateur temps)</h3>

            <div class="tarif-field">
              <label>Rez-de-chaussee</label>
              <div class="input-group">
                <input type="number" id="facteurEtage_rdc" min="0.5" step="0.05">
                <span class="unit">x</span>
              </div>
            </div>

            <div class="tarif-field">
              <label>2e etage (sans ascenseur)</label>
              <div class="input-group">
                <input type="number" id="facteurEtage_2e" min="0.5" step="0.05">
                <span class="unit">x</span>
              </div>
            </div>

            <div class="tarif-field">
              <label>3e etage (sans ascenseur)</label>
              <div class="input-group">
                <input type="number" id="facteurEtage_3e" min="0.5" step="0.05">
                <span class="unit">x</span>
              </div>
            </div>

            <div class="tarif-field">
              <label>4e etage et + (sans ascenseur)</label>
              <div class="input-group">
                <input type="number" id="facteurEtage_4e" min="0.5" step="0.05">
                <span class="unit">x</span>
              </div>
            </div>

            <div class="tarif-field">
              <label>Avec ascenseur</label>
              <div class="input-group">
                <input type="number" id="facteurEtage_ascenseur" min="0.5" step="0.05">
                <span class="unit">x</span>
              </div>
            </div>
          </div>

          <!-- Temps par taille de logement : Chargement -->
          <div class="tarif-card" style="grid-column: 1 / -1;">
            <h3>Temps de chargement par taille de logement (RDC, avant facteur etage)</h3>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
              <div class="tarif-field" style="flex-direction: column; align-items: flex-start;">
                <label>1 &frac12;</label>
                <div class="input-group">
                  <input type="number" id="temps_1_5_chargement" min="0" step="5">
                  <span class="unit">min</span>
                </div>
              </div>
              <div class="tarif-field" style="flex-direction: column; align-items: flex-start;">
                <label>2 &frac12;</label>
                <div class="input-group">
                  <input type="number" id="temps_2_5_chargement" min="0" step="5">
                  <span class="unit">min</span>
                </div>
              </div>
              <div class="tarif-field" style="flex-direction: column; align-items: flex-start;">
                <label>3 &frac12;</label>
                <div class="input-group">
                  <input type="number" id="temps_3_5_chargement" min="0" step="5">
                  <span class="unit">min</span>
                </div>
              </div>
              <div class="tarif-field" style="flex-direction: column; align-items: flex-start;">
                <label>4 &frac12;</label>
                <div class="input-group">
                  <input type="number" id="temps_4_5_chargement" min="0" step="5">
                  <span class="unit">min</span>
                </div>
              </div>
              <div class="tarif-field" style="flex-direction: column; align-items: flex-start;">
                <label>5 &frac12;</label>
                <div class="input-group">
                  <input type="number" id="temps_5_5_chargement" min="0" step="5">
                  <span class="unit">min</span>
                </div>
              </div>
              <div class="tarif-field" style="flex-direction: column; align-items: flex-start;">
                <label>Maison</label>
                <div class="input-group">
                  <input type="number" id="temps_maison_chargement" min="0" step="5">
                  <span class="unit">min</span>
                </div>
              </div>
              <div class="tarif-field" style="flex-direction: column; align-items: flex-start;">
                <label>Commercial</label>
                <div class="input-group">
                  <input type="number" id="temps_commercial_chargement" min="0" step="5">
                  <span class="unit">min</span>
                </div>
              </div>
              <div class="tarif-field" style="flex-direction: column; align-items: flex-start;">
                <label>Autre</label>
                <div class="input-group">
                  <input type="number" id="temps_autre_chargement" min="0" step="5">
                  <span class="unit">min</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Temps par taille de logement : Dechargement -->
          <div class="tarif-card" style="grid-column: 1 / -1;">
            <h3>Temps de dechargement par taille de logement (RDC, avant facteur etage)</h3>

            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px;">
              <div class="tarif-field" style="flex-direction: column; align-items: flex-start;">
                <label>1 &frac12;</label>
                <div class="input-group">
                  <input type="number" id="temps_1_5_dechargement" min="0" step="5">
                  <span class="unit">min</span>
                </div>
              </div>
              <div class="tarif-field" style="flex-direction: column; align-items: flex-start;">
                <label>2 &frac12;</label>
                <div class="input-group">
                  <input type="number" id="temps_2_5_dechargement" min="0" step="5">
                  <span class="unit">min</span>
                </div>
              </div>
              <div class="tarif-field" style="flex-direction: column; align-items: flex-start;">
                <label>3 &frac12;</label>
                <div class="input-group">
                  <input type="number" id="temps_3_5_dechargement" min="0" step="5">
                  <span class="unit">min</span>
                </div>
              </div>
              <div class="tarif-field" style="flex-direction: column; align-items: flex-start;">
                <label>4 &frac12;</label>
                <div class="input-group">
                  <input type="number" id="temps_4_5_dechargement" min="0" step="5">
                  <span class="unit">min</span>
                </div>
              </div>
              <div class="tarif-field" style="flex-direction: column; align-items: flex-start;">
                <label>5 &frac12;</label>
                <div class="input-group">
                  <input type="number" id="temps_5_5_dechargement" min="0" step="5">
                  <span class="unit">min</span>
                </div>
              </div>
              <div class="tarif-field" style="flex-direction: column; align-items: flex-start;">
                <label>Maison</label>
                <div class="input-group">
                  <input type="number" id="temps_maison_dechargement" min="0" step="5">
                  <span class="unit">min</span>
                </div>
              </div>
              <div class="tarif-field" style="flex-direction: column; align-items: flex-start;">
                <label>Commercial</label>
                <div class="input-group">
                  <input type="number" id="temps_commercial_dechargement" min="0" step="5">
                  <span class="unit">min</span>
                </div>
              </div>
              <div class="tarif-field" style="flex-direction: column; align-items: flex-start;">
                <label>Autre</label>
                <div class="input-group">
                  <input type="number" id="temps_autre_dechargement" min="0" step="5">
                  <span class="unit">min</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Taxes -->
          <div class="tarif-card">
            <h3>Taxes</h3>

            <div class="tarif-field">
              <label>TPS (taxe federale)</label>
              <div class="input-group">
                <input type="number" id="taxeTPS" min="0" step="0.1">
                <span class="unit">%</span>
              </div>
            </div>

            <div class="tarif-field">
              <label>TVQ (taxe provinciale)</label>
              <div class="input-group">
                <input type="number" id="taxeTVQ" min="0" step="0.1">
                <span class="unit">%</span>
              </div>
            </div>
          </div>

        </div>

        <div class="last-update" id="lastUpdate"></div>
      </div>

      <!-- TAB : RESERVATIONS -->
      <div class="admin-tab-panel" id="tabReservations">

        <div class="resa-filters">
          <button class="resa-filter-btn active" data-filter="all">Toutes</button>
          <button class="resa-filter-btn" data-filter="en_attente">En attente</button>
          <button class="resa-filter-btn" data-filter="approuve">Approuvees</button>
          <button class="resa-filter-btn" data-filter="refuse">Refusees</button>
        </div>

        <div class="resa-list" id="resaList">
          <div class="resa-empty">Aucune reservation pour le moment.</div>
        </div>
      </div>

    </div>
  </section>

  <!-- Save Bar -->
  <div class="save-bar admin-panel" id="saveBar">
    <div class="container">
      <span class="save-status" id="saveStatus">Modifiez les valeurs ci-dessus</span>
      <div class="save-buttons">
        <button class="btn btn-outline" id="btnReset" style="border-color: var(--error); color: var(--error);">Reinitialiser</button>
        <button class="btn btn-primary" id="btnSave">Sauvegarder les tarifs</button>
      </div>
    </div>
  </div>

  <script src="js/main.js"></script>
  <script src="js/devis-engine.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {

      // --- MOT DE PASSE ADMIN ---
      var ADMIN_PASSWORD = 'premier2026';

      var loginForm = document.getElementById('loginForm');
      var loginSection = document.getElementById('loginSection');
      var adminPanel = document.getElementById('adminPanel');
      var saveBar = document.getElementById('saveBar');
      var loginError = document.getElementById('loginError');

      // Verifier si deja connecte cette session
      if (sessionStorage.getItem('pe_admin_auth') === 'true') {
        showAdmin();
      }

      loginForm.addEventListener('submit', function (e) {
        e.preventDefault();
        var pass = document.getElementById('adminPass').value;
        if (pass === ADMIN_PASSWORD) {
          sessionStorage.setItem('pe_admin_auth', 'true');
          showAdmin();
        } else {
          loginError.style.display = 'block';
        }
      });

      function showAdmin() {
        loginSection.style.display = 'none';
        adminPanel.classList.add('visible');
        saveBar.classList.add('visible');
        chargerFormulaire();
        chargerReservations();
      }

      // --- ONGLETS ---
      document.querySelectorAll('.admin-tab').forEach(function (tab) {
        tab.addEventListener('click', function () {
          document.querySelectorAll('.admin-tab').forEach(function (t) { t.classList.remove('active'); });
          document.querySelectorAll('.admin-tab-panel').forEach(function (p) { p.classList.remove('active'); });
          this.classList.add('active');
          var tabId = 'tab' + this.getAttribute('data-tab').charAt(0).toUpperCase() + this.getAttribute('data-tab').slice(1);
          document.getElementById(tabId).classList.add('active');

          // Show/hide save bar depending on tab
          if (this.getAttribute('data-tab') === 'tarifs') {
            saveBar.style.display = '';
          } else {
            saveBar.style.display = 'none';
          }
        });
      });

      // --- CHARGER LES TARIFS DANS LE FORMULAIRE ---
      var tarifFields = [
        'tauxHoraireBase', 'majorationWeekend', 'majorationJuillet',
        'majorationFinMois', 'heureFixeDeplacement', 'seuilDeplacementMin',
        'vitesseMoyenne', 'facteurTrafic', 'pauseParHeure',
        'nombreDemenageurs', 'nombreCamions',
        'facteurEtage_rdc', 'facteurEtage_2e', 'facteurEtage_3e',
        'facteurEtage_4e', 'facteurEtage_ascenseur',
        'taxeTPS', 'taxeTVQ',
        'temps_1_5_chargement', 'temps_1_5_dechargement',
        'temps_2_5_chargement', 'temps_2_5_dechargement',
        'temps_3_5_chargement', 'temps_3_5_dechargement',
        'temps_4_5_chargement', 'temps_4_5_dechargement',
        'temps_5_5_chargement', 'temps_5_5_dechargement',
        'temps_maison_chargement', 'temps_maison_dechargement',
        'temps_commercial_chargement', 'temps_commercial_dechargement',
        'temps_autre_chargement', 'temps_autre_dechargement'
      ];

      function chargerFormulaire() {
        var tarifs = DevisEngine.chargerTarifs();

        tarifFields.forEach(function (f) {
          var el = document.getElementById(f);
          if (el) el.value = tarifs[f];
        });

        // Derniere MAJ
        if (tarifs.derniereMiseAJour) {
          var d = new Date(tarifs.derniereMiseAJour);
          document.getElementById('lastUpdate').textContent =
            'Derniere mise a jour : ' + d.toLocaleDateString('fr-CA') + ' a ' + d.toLocaleTimeString('fr-CA');
        }
      }

      // --- SAUVEGARDER ---
      document.getElementById('btnSave').addEventListener('click', function () {
        var tarifs = DevisEngine.chargerTarifs();

        tarifFields.forEach(function (f) {
          var el = document.getElementById(f);
          if (el) tarifs[f] = parseFloat(el.value) || 0;
        });

        DevisEngine.sauvegarderTarifs(tarifs);

        var status = document.getElementById('saveStatus');
        status.textContent = 'Tarifs sauvegardes avec succes!';
        status.classList.add('saved');

        chargerFormulaire();

        setTimeout(function () {
          status.textContent = 'Modifiez les valeurs ci-dessus';
          status.classList.remove('saved');
        }, 3000);
      });

      // --- REINITIALISER ---
      document.getElementById('btnReset').addEventListener('click', function () {
        if (confirm('Reinitialiser tous les tarifs aux valeurs par defaut?')) {
          DevisEngine.reinitialiserTarifs();
          chargerFormulaire();

          var status = document.getElementById('saveStatus');
          status.textContent = 'Tarifs reinitialises aux valeurs par defaut.';
          status.classList.add('saved');
          setTimeout(function () {
            status.textContent = 'Modifiez les valeurs ci-dessus';
            status.classList.remove('saved');
          }, 3000);
        }
      });

      // --- RESERVATIONS ---
      var currentFilter = 'all';

      function chargerReservations() {
        var reservations = DevisEngine.chargerReservations();

        // Compter les en attente
        var enAttente = reservations.filter(function (r) { return r.statut === 'en_attente'; }).length;
        document.getElementById('resaCount').textContent = enAttente;

        afficherReservations(reservations, currentFilter);
      }

      function afficherReservations(reservations, filtre) {
        var liste = document.getElementById('resaList');

        var filtrees = reservations;
        if (filtre !== 'all') {
          filtrees = reservations.filter(function (r) { return r.statut === filtre; });
        }

        // Trier par date de creation (plus recentes en premier)
        filtrees.sort(function (a, b) {
          return new Date(b.dateCreation) - new Date(a.dateCreation);
        });

        if (filtrees.length === 0) {
          liste.innerHTML = '<div class="resa-empty">Aucune reservation ' +
            (filtre === 'all' ? '' : 'avec ce statut ') + 'pour le moment.</div>';
          return;
        }

        var statutLabels = {
          'en_attente': 'En attente',
          'approuve': 'Approuvee',
          'refuse': 'Refusee'
        };

        var html = '';
        filtrees.forEach(function (r) {
          var dateCreation = new Date(r.dateCreation);
          var dateFormatee = dateCreation.toLocaleDateString('fr-CA') + ' ' + dateCreation.toLocaleTimeString('fr-CA', {hour:'2-digit', minute:'2-digit'});
          var dateDemenagement = r.date || '-';

          html += '<div class="resa-card">' +
            '<div class="resa-card-header">' +
            '<div><span class="resa-id">' + r.id + '</span>' +
            '<span style="color:var(--gray-400);font-size:0.85rem;margin-left:12px;">' + dateFormatee + '</span></div>' +
            '<span class="resa-statut ' + r.statut + '">' + statutLabels[r.statut] + '</span>' +
            '</div>' +
            '<div class="resa-details">' +
            '<div class="resa-detail-item"><span class="resa-label">Client</span><span class="resa-value">' +
            (r.client ? r.client.prenom + ' ' + r.client.nom : '-') + '</span></div>' +
            '<div class="resa-detail-item"><span class="resa-label">Telephone</span><span class="resa-value">' +
            (r.client ? r.client.telephone : '-') + '</span></div>' +
            '<div class="resa-detail-item"><span class="resa-label">Courriel</span><span class="resa-value">' +
            (r.client ? r.client.email : '-') + '</span></div>' +
            '<div class="resa-detail-item"><span class="resa-label">Date demenagement</span><span class="resa-value">' + dateDemenagement + '</span></div>' +
            '<div class="resa-detail-item"><span class="resa-label">Logement</span><span class="resa-value">' + (r.tailleLogement || '-') + '</span></div>' +
            '<div class="resa-detail-item"><span class="resa-label">Distance</span><span class="resa-value">' + (r.distanceKm || 0) + ' km</span></div>' +
            '<div class="resa-detail-item"><span class="resa-label">Etage ramassage</span><span class="resa-value">' + (r.etageRamassage || '-') + '</span></div>' +
            '<div class="resa-detail-item"><span class="resa-label">Etage depot</span><span class="resa-value">' + (r.etageDepot || '-') + '</span></div>' +
            '<div class="resa-detail-item"><span class="resa-label">Duree estimee</span><span class="resa-value">' + (r.tempsTotalHeures || 0) + ' h</span></div>' +
            '<div class="resa-detail-item"><span class="resa-label">Horaire</span><span class="resa-value">08:00 - ' + (r.heureFinEstimee || '-') + '</span></div>' +
            '<div class="resa-detail-item"><span class="resa-label">Taux effectif</span><span class="resa-value">' + (r.tauxEffectif || 0) + ' $/h</span></div>' +
            '<div class="resa-detail-item"><span class="resa-label">Total estime</span><span class="resa-value" style="color:var(--demenagement);font-weight:700;">' + (r.total || 0).toFixed(2) + ' $</span></div>' +
            '</div>';

          if (r.client && r.client.notes) {
            html += '<div style="padding:8px 0;font-size:0.9rem;color:var(--gray-600);"><strong>Notes:</strong> ' + r.client.notes + '</div>';
          }

          if (r.statut === 'en_attente') {
            html += '<div class="resa-actions">' +
              '<button class="resa-btn resa-btn-approve" data-id="' + r.id + '">Approuver</button>' +
              '<button class="resa-btn resa-btn-refuse" data-id="' + r.id + '">Refuser</button>' +
              '</div>';
          }

          html += '</div>';
        });

        liste.innerHTML = html;
      }

      // --- Filtres de reservation ---
      document.querySelectorAll('.resa-filter-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          document.querySelectorAll('.resa-filter-btn').forEach(function (b) { b.classList.remove('active'); });
          this.classList.add('active');
          currentFilter = this.getAttribute('data-filter');
          chargerReservations();
        });
      });

      // --- Actions approuver/refuser ---
      document.addEventListener('click', function (e) {
        if (e.target.classList.contains('resa-btn-approve')) {
          var id = e.target.getAttribute('data-id');
          var result = DevisEngine.approuverReservation(id);
          if (result.success) {
            chargerReservations();
          } else {
            alert(result.message || 'Erreur lors de l\'approbation.');
          }
        }
        if (e.target.classList.contains('resa-btn-refuse')) {
          var id = e.target.getAttribute('data-id');
          if (confirm('Refuser cette reservation?')) {
            DevisEngine.refuserReservation(id);
            chargerReservations();
          }
        }
      });

    });
  </script>
</body>
</html>
